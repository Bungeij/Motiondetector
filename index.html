<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Nacht-Wächter – Dual-Kamera Autoalarm</title>
<style>
  body{margin:0;background:#0b0e12;color:#d8dee9;font-family:sans-serif;}
  .wrap{display:flex;flex-direction:row;gap:12px;height:100vh;padding:10px;box-sizing:border-box;}
  .videoBox{flex:1;display:flex;flex-direction:column;gap:6px;}
  video{width:100%;height:100%;object-fit:cover;border-radius:10px;background:#000;}
  .status{background:#12161c;border:1px solid #2a3444;padding:8px;border-radius:8px;font-size:14px}
  button{margin-top:6px;padding:8px 12px;border-radius:8px;border:1px solid #2a3444;background:#13304a;color:#fff;font-size:14px}
</style>
</head>
<body>
<div class="wrap">
  <div class="videoBox">
    <video id="videoBack" autoplay playsinline muted></video>
    <div class="status" id="statusBack">Back: bereit</div>
  </div>
  <div class="videoBox">
    <video id="videoFront" autoplay playsinline muted></video>
    <div class="status" id="statusFront">Front: bereit</div>
  </div>
</div>
<button id="startBtn">Kameras starten</button>
<button id="resetBtn">Reset</button>
<canvas id="workBack" width="320" height="180" hidden></canvas>
<canvas id="workFront" width="320" height="180" hidden></canvas>

<script>
const videoBack = document.getElementById('videoBack');
const videoFront = document.getElementById('videoFront');
const workBack = document.getElementById('workBack');
const workFront = document.getElementById('workFront');
const ctxBack = workBack.getContext('2d', {willReadFrequently:true});
const ctxFront = workFront.getContext('2d', {willReadFrequently:true});
const statusBack = document.getElementById('statusBack');
const statusFront = document.getElementById('statusFront');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');

let prevBack=null, prevFront=null;
let alarmOn=false, lastAlarm=0;
let audio=null, audioReady=false;

async function startAudio(){
  if(audioReady) return;
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator(); osc.type="sawtooth";
  const lfo = ctx.createOscillator(); lfo.type="square"; lfo.frequency.value=6;
  const gain = ctx.createGain(); gain.gain.value=0.0;
  const lfoGain = ctx.createGain(); lfoGain.gain.value=400;
  lfo.connect(lfoGain).connect(osc.frequency);
  osc.connect(gain).connect(ctx.destination);
  osc.start(); lfo.start();
  audio={ctx,osc,gain}; audioReady=true;
}
function triggerAlarm(){
  const now=performance.now();
  if(now-lastAlarm<6000) return; // max alle 6s
  lastAlarm=now;
  if(!audioReady) return;
  alarmOn=true;
  audio.gain.gain.setTargetAtTime(0.6,audio.ctx.currentTime,0.05);
  setTimeout(()=>{
    audio.gain.gain.setTargetAtTime(0.0,audio.ctx.currentTime,0.1);
    alarmOn=false;
  },6000);
}

function diffFrame(video, ctx, prev){
  ctx.drawImage(video,0,0,ctx.canvas.width,ctx.canvas.height);
  const curr=ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
  if(!prev) return {curr, motion:0, center:0, bright:0};
  let motion=0, center=0, bright=0;
  const w=ctx.canvas.width,h=ctx.canvas.height;
  const cx0=Math.floor(w*0.3),cx1=Math.floor(w*0.7),cy0=Math.floor(h*0.3),cy1=Math.floor(h*0.7);
  const p=prev.data,c=curr.data;
  for(let i=0;i<c.length;i+=4){
    const y=Math.floor((i/4)/w),x=(i/4)%w;
    const pd=(p[i]+p[i+1]+p[i+2])/3;
    const cd=(c[i]+c[i+1]+c[i+2])/3;
    const d=Math.abs(cd-pd);
    if(d>15){motion++; if(x>cx0&&x<cx1&&y>cy0&&y<cy1) center++;}
    bright+=cd;
  }
  const total=w*h;
  return {curr,motion:(motion/total)*100,center:(motion?center/motion*100:0),bright:bright/(total*255)};
}
function checkTrigger(res,statusEl){
  if(res.motion>2 && res.center>35 && (res.motion*1.8+res.bright*20)>20){
    statusEl.textContent="Annäherung erkannt!";
    triggerAlarm();
  }else{
    statusEl.textContent="Überwachung läuft …";
  }
}
async function startCams(){
  try{
    const back=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}},audio:false});
    videoBack.srcObject=back;
    const front=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    videoFront.srcObject=front;
    loop();
  }catch(e){
    console.error(e);
  }
}
function loop(){
  const resB=diffFrame(videoBack,ctxBack,prevBack); prevBack=resB.curr;
  checkTrigger(resB,statusBack);
  const resF=diffFrame(videoFront,ctxFront,prevFront); prevFront=resF.curr;
  checkTrigger(resF,statusFront);
  requestAnimationFrame(loop);
}
startBtn.addEventListener("click",async()=>{await startAudio(); await startCams();});
resetBtn.addEventListener("click",()=>{lastAlarm=0; alarmOn=false; if(audioReady) audio.gain.gain.value=0;});
</script>
</body>
</html>